# Docker Compose for Applications Only (ChatBots + Supamode)
# Connect to an existing Supabase instance (Cloud or Self-Hosted)
#
# Usage:
#   docker compose -f docker-compose.apps.yml up --build -d

services:
  # ChatBots Next.js Application
  chatbots:
    build:
      context: .
      dockerfile: apps/chatbots/Dockerfile
      args:
        NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL:-https://your-project.supabase.co}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY:-your-anon-key}
        NEXT_PUBLIC_SITE_URL: ${NEXT_PUBLIC_SITE_URL:-https://your-app.com}
        NEXT_PUBLIC_BILLING_PROVIDER: ${BILLING_PROVIDER:-stripe}
        NEXT_PUBLIC_PRODUCT_NAME: ${PRODUCT_NAME:-ChatBots}
        NEXT_PUBLIC_SITE_TITLE: ${SITE_TITLE:-ChatBots}
        NEXT_PUBLIC_SITE_DESCRIPTION: ${SITE_DESCRIPTION:-AI Chatbot Platform}
        EMAIL_SENDER: ${EMAIL_SENDER:-noreply@example.com}
    restart: unless-stopped
    environment:
      NODE_ENV: production
      # Runtime overrides (override build-time defaults)
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      EMAIL_SENDER: ${EMAIL_SENDER:-noreply@example.com}
    ports:
      - "${CHATBOTS_PORT:-3000}:3000"

  # Supamode API (Hono.js)
  supamode-api:
    build:
      context: ./supamode-main
      target: api-runner
    restart: unless-stopped
    # Force IPv4 for Supabase pooler connection
    extra_hosts:
      - "aws-0-us-east-1.pooler.supabase.com:44.216.29.125"
    dns:
      - 8.8.8.8
      - 8.8.4.4
    environment:
      NODE_ENV: production
      PORT: 3000
      SUPABASE_URL: ${SUPABASE_URL:-https://your-project.supabase.co}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:-your-anon-key}
      SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      SUPABASE_DATABASE_URL: ${SUPABASE_DATABASE_URL:-postgresql://postgres:password@db.your-project.supabase.co:5432/postgres}

  # Supamode Web (React/Vite + Nginx)
  supamode-web:
    build:
      context: ./supamode-main
      target: app-runner
      args:
        VITE_SUPABASE_URL: ${SUPABASE_URL:-https://your-project.supabase.co}
        VITE_SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:-your-anon-key}
        VITE_SITE_URL: ${SUPAMODE_URL:-https://admin.your-app.com}
    restart: unless-stopped
    depends_on:
      - supamode-api
    environment:
      API_URL: http://supamode-api:3000
    ports:
      - "${SUPAMODE_PORT:-8080}:80"


